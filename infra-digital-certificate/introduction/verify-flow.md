# 검증 절차

Cert 서비스를 활용하여 사용자(Holder)의 VP를 제출받고, 검증하기 위해서는 기본적으로 [ICP](../introduction/icp.md)을 따릅니다.

이는 Diffie-Hellman 알고리즘을 통해 검증자와 사용자 간 상호 암호화 통신을 지원하여 더욱 안전한 검증 절차를 지원합니다.

즉, 사용자와 검증자(verifier)가 WebSocket으로 연결하여 프로토콜 메시지에 따라 서로를 검증하고 VP 제출요청, VP 제출, 응답 등의 단계를 거칩니다.

또한 Cert 서비스는 다양한 실제 상황을 대응하기 위해 Cert Server의 REST API를 통한 검증 절차도 지원하고 있습니다.

## ICP

ICP에 따라 연결 방식에 대한 기본 시나리오는 다음과 같습니다:

1. 사용자 앱에서 웹소켓 채널을 생성하고 Dynamic QR Scan 방식으로 검증자 앱에게 채널 정보를 전달하여 검증자 앱이 해당 채널에 연결합니다.
   - 검증자앱이 Cert 서버에 정보를 전달하여 Cert 서버가 연결할 수 있습니다.
2. 검증자가 사전에 접속 정보를 전달할 service endpoint를 포함한 Static QR을 생성합니다. 사용자앱이 이를 스캔하여 웹소켓 채널 생성하여 이를 전달하고, 검증자 서버(Cert 서버)가 해당 채널에 연결합니다.
3. 검증자 앱에서 웹소켓 채널을 생성하고 Dynamic QR Scan 방식으로 사용자 앱에게 채널 정보를 전달하여 사용자 앱이 해당 채널에 연결합니다.
   - 검증자앱이 Cert 서버에 채널 생성을 요청하여 Cert 서버가 채널을 생성하고 그 정보를 받아 Dynamic QR을 생성하여 사용자와 Cert 서버가 연결할 수 있습니다.

서로 연결된 사용자와 검증자는 DID-Auth sub protocol을 따라 서로의 DID를 확인합니다.

상호 검증이 완료된 후 VP sub protocol에 따라서 VP 제출 요청, 제출/거절/지연제출, 응답을 진행합니다.

## REST API

지연제출에 대한 구성과 더불어 REST API만을 이용하여 VP 제출 요청과 제출 절차를 실시 할 수 있습니다. 직접 제출 방식의 경우 상호간의 확인을 위하여 요청과 응답은 프로토콜 메시지를 사용합니다.

### Submit-Later

1. ICP에 따라 진행 중 사용자가 Submit-Later 메세지를 전달할 경우 검증자측은 이후에 이를 제출할 수 있는 service endpoint를 전달합니다.
2. 사용자는 (제출 시)VP 생성하여 제출 API(service endpoint)로 Submit-VP 혹은 Reject-ReqVP 메시지를 전달합니다.
3. Cert 서버는 이에 대해 VP검증, 저장, 검증자의 서비스 서버에 콜백 등을 수행하고 Submit-VP-Res 혹은 Reject-ReqVP-Res 메시지를 전달합니다.

### 직접 제출 방식

1. 검증자는 Cert 서버에 Static 검증요청을 생성하고 이를 확인할 service endpoint를 포함한 static QR, 링크 등으로 해당 정보를 사용자에게 전달합니다.
2. 사용자는 service endpoint로 VP제출요청을 확인합니다.
3. Cert 서버에서는 확인한 사용자의 DID를 포함하여 'VP 제출 요청'을 생성하며 ICP의 VP-Req 메세지와 제출받을 service endpoint를 전달합니다.
4. 사용자는 이를 검증하고 (제출 시)VP 생성하여 제출 API(service endpoint)로 Submit-VP 혹은 Reject-ReqVP 메시지를 전달합니다.
5. Cert 서버는 이에 대해 VP검증, 저장, 검증자의 서비스 서버에 콜백 등을 수행하고 Submit-VP-Res 혹은 Reject-ReqVP-Res 메시지를 전달합니다.

## 사용자 시나리오

Cert 서비스는 서비스 제공자의 상황과 환경에 맞추어 다양한 방식을 제공합니다.

서비스 제공자는 상황에 맞는 서비스 흐름을 구현할 수 있습니다.

예를 들어

1. 자체 서버 개발 자원이 부족하고 빠른 개발을 원할 경우, 대부분의 처리를 Cert 서버에 일임하는 방식(static QR 연결, REST API 제출방식)을 도입하면 사용자 앱 개발에 집중할 수 있습니다.
2. VP 제출 이전에 사용자의 별도 행위가 필요한 경우 Submit-Later 관련 로직을 선택적으로 구현할 수 있습니다.
3. 검증 이력 등이 Cert 서버에 저장되길 원하지 않는 경우, Dynamic QR을 이용하여 앱 간 제출, 검증 흐름으로 서비스를 제공하여 직접 VP 제출, 검증할 수 있습니다.
4. 웹을 통해 제공되는 서비스가 있는 경우 REST API를 사용하여 사용자 앱과 Cert 서버가 검증 절차를 수행하고 웹 서비스 서버에게 콜백을 전달하는 형태로 개발할 수 있습니다.

- _각 케이스는 배타적이지 않습니다. 사용자의 선택 자유를 위해 모든 케이스를 한 서비스에서 지원할 수 있습니다._

좀 더 복잡한 사례나 적합한 케이스에 대한 도움이 필요하다면 [메일 문의](contact@bc-labs.net)를 통해 직접 문의하실 수 있습니다.

프로토콜에 대한 상세한 로직은 [ICP](../introduction/icp.md)를 참조하시고, 사용자 시나리오 측면에서의 시나리오와 시퀀스 다이어그램을
